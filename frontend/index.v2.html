<!DOCTYPE html>
<html lang="en" class="h-full bg-gray-50">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Salt Server</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
    .tab-content { display: none; }
    .tab-content.active { display: block; }
  </style>
</head>
<body class="min-h-screen flex items-center justify-center p-4">

  <div class="w-full max-w-2xl bg-white rounded-xl shadow-lg p-6 space-y-6">

    <h1 class="text-2xl font-bold text-center text-gray-800">Salt Key Server</h1>

    <!-- Tabs -->
    <div class="flex space-x-1 border-b">
      <button id="tab-email" class="tab-btn active px-4 py-2 text-sm font-medium text-blue-600 border-b-2 border-blue-600">
        Email Mode
      </button>
      <button id="tab-anon" class="tab-btn px-4 py-2 text-sm font-medium text-gray-600 hover:text-gray-800">
        Anonymous Link
      </button>
    </div>

    <!-- Email Mode -->
    <div id="email" class="tab-content active space-y-4">
      <div>
        <label class="block text-sm font-medium text-gray-700">Email</label>
        <input type="email" id="email-input" placeholder="you@example.com"
               class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:ring-blue-500 focus:border-blue-500">
      </div>

      <div>
        <div class="flex justify-between items-center mb-1">
          <label class="text-sm font-medium text-gray-700">Salt (Base64)</label>
          <button onclick="generateSalt('salt-email')" class="text-xs px-3 py-1 bg-green-600 text-white rounded hover:bg-green-700">
            Generate
          </button>
        </div>
        <textarea id="salt-email" rows="3" placeholder="Click Generate or paste Base64 salt..."
                  class="block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:ring-blue-500 focus:border-blue-500"></textarea>
      </div>

      <button onclick="uploadWithEmail()" class="w-full py-2 px-4 bg-blue-600 text-white font-medium rounded-md hover:bg-blue-700">
        Upload Salt
      </button>
      <pre id="result-email" class="mt-4 p-3 bg-gray-100 rounded text-sm overflow-x-auto hidden"></pre>
    </div>

    <!-- Anonymous Mode -->
    <div id="anon" class="tab-content space-y-4">
      <div>
        <div class="flex justify-between items-center mb-1">
          <label class="text-sm font-medium text-gray-700">Salt (Base64)</label>
          <button onclick="generateSalt('salt-anon')" class="text-xs px-3 py-1 bg-green-600 text-white rounded hover:bg-green-700">
            Generate
          </button>
        </div>
        <textarea id="salt-anon" rows="3" placeholder="Click Generate or paste Base64 salt..."
                  class="block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:ring-blue-500 focus:border-blue-500"></textarea>
      </div>

      <button onclick="uploadAnon()" class="w-full py-2 px-4 bg-indigo-600 text-white font-medium rounded-md hover:bg-indigo-700">
        Get Anonymous Link
      </button>
      <pre id="result-anon" class="mt-4 p-3 bg-gray-100 rounded text-sm overflow-x-auto hidden"></pre>

      <div class="pt-4 border-t">
        <label class="block text-sm font-medium text-gray-700 mb-1">Paste Link to Retrieve</label>
        <input type="text" id="anon-url" placeholder="https://yoursite.com/s/abc123..."
               class="block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm text-sm">
        <button onclick="fetchByLink()" class="mt-2 w-full py-2 px-4 bg-gray-600 text-white font-medium rounded-md hover:bg-gray-700">
          Fetch Salt
        </button>
        <pre id="link-result" class="mt-3 p-3 bg-gray-100 rounded text-sm overflow-x-auto hidden"></pre>
      </div>
    </div>

    <!-- Retrieve by Email (shared) -->
    <div class="pt-4 border-t">
      <label class="block text-sm font-medium text-gray-700 mb-1">Retrieve by Email</label>
      <div class="flex space-x-2">
        <input type="email" id="fetch-email" placeholder="you@example.com"
               class="flex-1 px-3 py-2 border border-gray-300 rounded-md shadow-sm text-sm">
        <button onclick="fetchByEmail()" class="px-4 py-2 bg-gray-600 text-white font-medium rounded-md hover:bg-gray-700">
          Get
        </button>
      </div>
      <pre id="fetch-result" class="mt-3 p-3 bg-gray-100 rounded text-sm overflow-x-auto hidden"></pre>
    </div>

  </div>

  <script>
    const API_BASE = "https://keyserver-backend.arsalanse.ir";

    // Tab switching
    document.getElementById('tab-email').onclick = () => switchTab('email');
    document.getElementById('tab-anon').onclick = () => switchTab('anon');

    function switchTab(id) {
      document.querySelectorAll('.tab-content').forEach(el => el.classList.remove('active'));
      document.querySelectorAll('.tab-btn').forEach(btn => {
        btn.classList.remove('text-blue-600', 'border-blue-600');
        btn.classList.add('text-gray-600');
      });
      document.getElementById(id).classList.add('active');
      document.getElementById(`tab-${id}`).classList.add('text-blue-600', 'border-blue-600');
      document.getElementById(`tab-${id}`).classList.remove('text-gray-600');
    }

    // Generate secure Base64 salt (16 bytes)
    function generateSalt(id) {
      const array = new Uint8Array(16);
      crypto.getRandomValues(array);
      const base64 = btoa(String.fromCharCode(...array))
        .replace(/\+/g, '-').replace(/\//g, '_').replace(/=+$/, '');
      document.getElementById(id).value = base64;
    }

    // Show result
    function showResult(id, data, isLink = false) {
      const el = document.getElementById(id);
      el.textContent = JSON.stringify(data, null, 2);
      if (isLink && data.url) {
        el.innerHTML = el.innerHTML.replace(
          `"${data.url}"`,
          `<a href="${data.url}" target="_blank" class="text-blue-600 underline">${data.url}</a>`
        );
      }
      el.classList.remove('hidden');
    }

    // Email upload
    async function uploadWithEmail() {
      const email = document.getElementById('email-input').value.trim();
      const salt = document.getElementById('salt-email').value.trim();
      if (!email || !salt) return alert('Fill email and salt');
      try {
        const res = await fetch(`${API_BASE}/upload-salt`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ email, salt })
        });
        const data = await res.json();
        showResult('result-email', res.ok ? data : { error: data.detail });
      } catch (e) {
        showResult('result-email', { error: e.message });
      }
    }

    // Anon upload
    async function uploadAnon() {
      const salt = document.getElementById('salt-anon').value.trim();
      if (!salt) return alert('Generate or enter salt');
      try {
        const res = await fetch(`${API_BASE}/upload-salt-anon`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ salt })
        });
        const data = await res.json();
        showResult('result-anon', data, true);
      } catch (e) {
        showResult('result-anon', { error: e.message });
      }
    }

    // Fetch by email
    async function fetchByEmail() {
      const email = document.getElementById('fetch-email').value.trim();
      if (!email) return alert('Enter email');
      try {
        const res = await fetch(`${API_BASE}/salt/${encodeURIComponent(email)}`);
        const data = await res.json();
        showResult('fetch-result', res.ok ? data : { error: data.detail || 'Not found' });
      } catch (e) {
        showResult('fetch-result', { error: e.message });
      }
    }

    // Fetch by link
    async function fetchByLink() {
      let url = document.getElementById('anon-url').value.trim();
      if (!url) return alert('Paste the link');
      if (!url.startsWith('http')) url = API_BASE + url.replace(/^\/+/, '/');
      try {
        const res = await fetch(url);
        const data = await res.json();
        showResult('link-result', res.ok ? data : { error: data.detail || 'Not found' });
      } catch (e) {
        showResult('link-result', { error: e.message });
      }
    }
  </script>

</body>
</html>