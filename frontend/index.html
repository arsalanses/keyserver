<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Salt Keyserver ðŸ§‚</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="icon" href="data:image/svg+xml,<svg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 100 100%22><text y=%22.9em%22 font-size=%2290%22>ðŸ§‚</text></svg>">
</head>
<body class="bg-gradient-to-br from-slate-900 to-slate-800 text-white min-h-screen flex flex-col">
    <header class="p-4 text-center">
        <h1 class="text-3xl font-bold">Salt Keyserver</h1>
    </header>
    <main class="flex-grow container mx-auto p-4 space-y-8">
        <section id="generate-share" class="bg-slate-800 p-6 rounded-lg shadow-lg">
            <h2 class="text-2xl mb-4">Generate & Share Salt</h2>
            <div class="flex flex-col gap-4">
                <button id="generate-btn" class="bg-indigo-600 hover:bg-indigo-700 text-white py-2 px-4 rounded">Generate New Salt</button>
                <div class="relative">
                    <textarea id="salt-text" readonly class="w-full bg-slate-700 p-2 rounded" rows="3"></textarea>
                    <button id="copy-salt" class="absolute top-2 right-2 bg-blue-500 hover:bg-blue-600 text-white py-1 px-2 rounded text-sm">Copy</button>
                </div>
                <div class="flex items-center gap-4">
                    <label>Share Method:</label>
                    <label class="flex items-center gap-1"><input type="radio" name="share-method" value="email" checked> With Email</label>
                    <label class="flex items-center gap-1"><input type="radio" name="share-method" value="anon"> Anonymous</label>
                </div>
                <div id="email-share" class="flex flex-col gap-2">
                    <input id="email-input" type="email" placeholder="Enter your email" class="bg-slate-700 p-2 rounded">
                    <button id="upload-email-btn" class="bg-indigo-600 hover:bg-indigo-700 text-white py-2 px-4 rounded">Upload Salt</button>
                </div>
                <div id="anon-share" class="hidden flex flex-col gap-2">
                    <button id="upload-anon-btn" class="bg-indigo-600 hover:bg-indigo-700 text-white py-2 px-4 rounded">Create Share Link</button>
                </div>
                <div id="success-email" class="hidden text-green-300"></div>
                <div id="success-anon" class="hidden flex flex-col gap-2">
                    <input id="share-url" readonly class="bg-slate-700 p-2 rounded">
                    <button id="copy-url" class="bg-blue-500 hover:bg-blue-600 text-white py-1 px-2 rounded">Copy URL</button>
                </div>
            </div>
        </section>
        <section id="retrieve-email" class="bg-slate-800 p-6 rounded-lg shadow-lg">
            <h2 class="text-2xl mb-4">Retrieve by Email</h2>
            <div class="flex flex-col gap-4">
                <input id="retrieve-email" type="email" placeholder="Enter email" class="bg-slate-700 p-2 rounded">
                <div class="flex gap-2">
                    <button id="get-salt-email" class="bg-indigo-600 hover:bg-indigo-700 text-white py-2 px-4 rounded flex-1">Get Salt</button>
                    <button id="check-ttl" class="bg-blue-500 hover:bg-blue-600 text-white py-2 px-4 rounded flex-1">Check TTL</button>
                </div>
                <div class="relative hidden" id="salt-display-email">
                    <textarea id="salt-text-email" readonly class="w-full bg-slate-700 p-2 rounded" rows="3"></textarea>
                    <button id="copy-salt-email" class="absolute top-2 right-2 bg-blue-500 hover:bg-blue-600 text-white py-1 px-2 rounded text-sm">Copy</button>
                </div>
                <div id="ttl-display" class="text-blue-300"></div>
            </div>
        </section>
        <section id="retrieve-path" class="bg-slate-800 p-6 rounded-lg shadow-lg">
            <h2 class="text-2xl mb-4">Retrieve by Path (Anonymous)</h2>
            <div class="flex flex-col gap-4">
                <input id="path-input" type="text" placeholder="Enter path (e.g., abc123)" class="bg-slate-700 p-2 rounded">
                <p>Full URL: <span id="full-url" class="text-blue-300"></span></p>
                <button id="get-salt-path" class="bg-indigo-600 hover:bg-indigo-700 text-white py-2 px-4 rounded">Get Salt</button>
                <div class="relative hidden" id="salt-display-path">
                    <textarea id="salt-text-path" readonly class="w-full bg-slate-700 p-2 rounded" rows="3"></textarea>
                    <button id="copy-salt-path" class="absolute top-2 right-2 bg-blue-500 hover:bg-blue-600 text-white py-1 px-2 rounded text-sm">Copy</button>
                </div>
            </div>
        </section>
    </main>
    <footer class="p-4 text-center text-sm">
        Temporary salt sharing (5min TTL)
    </footer>
    <div id="toast-container" class="fixed top-4 right-4 z-50"></div>
    <script>
        const BASE_URL = 'https://keyserver-backend.arsalanse.ir';

        function showToast(message, type = 'info') {
            const container = document.getElementById('toast-container');
            const toast = document.createElement('div');
            toast.className = `p-4 rounded shadow-lg opacity-0 transition-opacity duration-300 ${type === 'success' ? 'bg-green-500' : type === 'error' ? 'bg-red-500' : 'bg-blue-500'}`;
            toast.textContent = message;
            container.appendChild(toast);
            setTimeout(() => toast.classList.add('opacity-100'), 100);
            setTimeout(() => {
                toast.classList.remove('opacity-100');
                setTimeout(() => container.removeChild(toast), 300);
            }, 3000);
        }

        function setLoading(btn, loading) {
            if (loading) {
                btn.dataset.originalText = btn.innerHTML;
                btn.disabled = true;
                btn.innerHTML = `Loading <span class="inline-block animate-spin ml-2">&#9694;</span>`;
            } else {
                btn.innerHTML = btn.dataset.originalText;
                btn.disabled = false;
            }
        }

        function generateSalt() {
            const array = new Uint8Array(32);
            crypto.getRandomValues(array);
            return Array.from(array, byte => byte.toString(16).padStart(2, '0')).join('');
        }

        function validateEmail(email) {
            return /^[^\s@]+@[^\s@]+\.[^\s@]+$/.test(email);
        }

        document.addEventListener('DOMContentLoaded', () => {
            const generateBtn = document.getElementById('generate-btn');
            generateBtn.click();
            document.getElementById('email-input').focus();

            const radios = document.querySelectorAll('input[name="share-method"]');
            radios.forEach(r => r.addEventListener('change', (e) => {
                document.getElementById('email-share').classList.toggle('hidden', e.target.value !== 'email');
                document.getElementById('anon-share').classList.toggle('hidden', e.target.value === 'email');
                document.getElementById('success-email').classList.add('hidden');
                document.getElementById('success-anon').classList.add('hidden');
            }));

            generateBtn.addEventListener('click', () => {
                const salt = generateSalt();
                const text = document.getElementById('salt-text');
                text.value = salt;
                text.focus();
                text.select();
                document.getElementById('success-email').classList.add('hidden');
                document.getElementById('success-anon').classList.add('hidden');
            });

            document.getElementById('copy-salt').addEventListener('click', () => {
                navigator.clipboard.writeText(document.getElementById('salt-text').value)
                    .then(() => showToast('Copied to clipboard!', 'success'))
                    .catch(() => showToast('Failed to copy', 'error'));
            });

            const uploadEmailBtn = document.getElementById('upload-email-btn');
            uploadEmailBtn.addEventListener('click', async () => {
                const email = document.getElementById('email-input').value;
                const salt = document.getElementById('salt-text').value;
                if (!salt) return showToast('Generate a salt first', 'error');
                if (!validateEmail(email)) return showToast('Invalid email address', 'error');
                setLoading(uploadEmailBtn, true);
                try {
                    const res = await fetch(`${BASE_URL}/upload-salt`, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ email, salt })
                    });
                    if (!res.ok) {
                        const errText = await res.text();
                        throw new Error(errText || 'Upload failed');
                    }
                    const data = await res.json();
                    const ttl = data.ttl || 300;
                    document.getElementById('success-email').innerHTML = `Uploaded! Expires in 5min. TTL: ${ttl} sec`;
                    document.getElementById('success-email').classList.remove('hidden');
                    showToast('Salt uploaded successfully', 'success');
                } catch (e) {
                    showToast(e.message || 'An error occurred', 'error');
                }
                setLoading(uploadEmailBtn, false);
            });

            const uploadAnonBtn = document.getElementById('upload-anon-btn');
            uploadAnonBtn.addEventListener('click', async () => {
                const salt = document.getElementById('salt-text').value;
                if (!salt) return showToast('Generate a salt first', 'error');
                setLoading(uploadAnonBtn, true);
                try {
                    const res = await fetch(`${BASE_URL}/upload-salt-anon`, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ salt })
                    });
                    if (!res.ok) {
                        const errText = await res.text();
                        throw new Error(errText || 'Upload failed');
                    }
                    const data = await res.json();
                    const path = data.path;
                    if (!path) throw new Error('No path returned');
                    const url = `${window.location.origin}/s/${path}`;
                    document.getElementById('share-url').value = url;
                    document.getElementById('success-anon').classList.remove('hidden');
                    navigator.clipboard.writeText(url)
                        .then(() => showToast('Share URL copied to clipboard!', 'success'))
                        .catch(() => showToast('Failed to auto-copy URL', 'error'));
                } catch (e) {
                    showToast(e.message || 'An error occurred', 'error');
                }
                setLoading(uploadAnonBtn, false);
            });

            document.getElementById('copy-url').addEventListener('click', () => {
                navigator.clipboard.writeText(document.getElementById('share-url').value)
                    .then(() => showToast('Copied to clipboard!', 'success'))
                    .catch(() => showToast('Failed to copy', 'error'));
            });

            const getSaltEmailBtn = document.getElementById('get-salt-email');
            getSaltEmailBtn.addEventListener('click', async () => {
                const email = document.getElementById('retrieve-email').value;
                if (!validateEmail(email)) return showToast('Invalid email address', 'error');
                setLoading(getSaltEmailBtn, true);
                try {
                    const res = await fetch(`${BASE_URL}/salt/${encodeURIComponent(email)}`);
                    if (!res.ok) {
                        const errText = await res.text();
                        throw new Error(errText || 'Salt not found or expired');
                    }
                    const data = await res.json();
                    document.getElementById('salt-text-email').value = data.salt;
                    document.getElementById('salt-display-email').classList.remove('hidden');
                    showToast('Salt retrieved successfully', 'success');
                } catch (e) {
                    showToast(e.message || 'An error occurred', 'error');
                    document.getElementById('salt-display-email').classList.add('hidden');
                }
                setLoading(getSaltEmailBtn, false);
            });

            const checkTtlBtn = document.getElementById('check-ttl');
            checkTtlBtn.addEventListener('click', async () => {
                const email = document.getElementById('retrieve-email').value;
                if (!validateEmail(email)) return showToast('Invalid email address', 'error');
                setLoading(checkTtlBtn, true);
                try {
                    const res = await fetch(`${BASE_URL}/ttl/${encodeURIComponent(email)}`);
                    if (!res.ok) {
                        const errText = await res.text();
                        throw new Error(errText || 'Salt not found or expired');
                    }
                    const data = await res.json();
                    document.getElementById('ttl-display').innerHTML = `${data.ttl} seconds left`;
                    showToast('TTL checked', 'success');
                } catch (e) {
                    document.getElementById('ttl-display').innerHTML = '';
                    showToast(e.message || 'An error occurred', 'error');
                }
                setLoading(checkTtlBtn, false);
            });

            document.getElementById('copy-salt-email').addEventListener('click', () => {
                navigator.clipboard.writeText(document.getElementById('salt-text-email').value)
                    .then(() => showToast('Copied to clipboard!', 'success'))
                    .catch(() => showToast('Failed to copy', 'error'));
            });

            const pathInput = document.getElementById('path-input');
            pathInput.addEventListener('input', () => {
                document.getElementById('full-url').textContent = pathInput.value ? `${window.location.origin}/s/${pathInput.value}` : '';
            });

            const getSaltPathBtn = document.getElementById('get-salt-path');
            getSaltPathBtn.addEventListener('click', async () => {
                const path = pathInput.value.trim();
                if (!path) return showToast('Enter a path', 'error');
                setLoading(getSaltPathBtn, true);
                try {
                    const res = await fetch(`${BASE_URL}/s/${path}`);
                    if (!res.ok) {
                        const errText = await res.text();
                        throw new Error(errText || 'Salt not found or expired');
                    }
                    const data = await res.json();
                    document.getElementById('salt-text-path').value = data.salt;
                    document.getElementById('salt-display-path').classList.remove('hidden');
                    showToast('Salt retrieved successfully', 'success');
                } catch (e) {
                    showToast(e.message || 'An error occurred', 'error');
                    document.getElementById('salt-display-path').classList.add('hidden');
                }
                setLoading(getSaltPathBtn, false);
            });

            document.getElementById('copy-salt-path').addEventListener('click', () => {
                navigator.clipboard.writeText(document.getElementById('salt-text-path').value)
                    .then(() => showToast('Copied to clipboard!', 'success'))
                    .catch(() => showToast('Failed to copy', 'error'));
            });

            document.getElementById('email-input').addEventListener('keydown', (e) => {
                if (e.key === 'Enter') {
                    e.preventDefault();
                    uploadEmailBtn.click();
                }
            });

            document.getElementById('retrieve-email').addEventListener('keydown', (e) => {
                if (e.key === 'Enter') {
                    e.preventDefault();
                    getSaltEmailBtn.click();
                }
            });

            pathInput.addEventListener('keydown', (e) => {
                if (e.key === 'Enter') {
                    e.preventDefault();
                    getSaltPathBtn.click();
                }
            });
        });
    </script>
</body>
</html>
