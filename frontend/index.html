<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Salt Keyserver</title>
  <style>
    body { font-family: system-ui, sans-serif; max-width: 800px; margin: 2rem auto; padding: 1rem; background: #f9fafb; }
    .card { background: white; padding: 1.5rem; margin: 1rem 0; border-radius: 12px; box-shadow: 0 2px 10px rgba(0,0,0,0.1); border: 1px solid #e5e7eb; }
    h1 { text-align: center; color: #1f2937; }
    .warning { background: #fef3c7; color: #92400e; padding: 1rem; text-align: center; border-radius: 8px; font-weight: 500; }
    label { display: block; margin: 0.5rem 0 0.25rem; font-weight: 600; color: #374151; }
    input, textarea { width: 90%; padding: 0.75rem; border: 1px solid #d1d5db; border-radius: 6px; font-family: monospace; }
    button { background: #3b82f6; color: white; border: none; padding: 0.75rem 1rem; border-radius: 6px; cursor: pointer; font-weight: 500; margin-top: 0.5rem; }
    button:hover { background: #2563eb; }
    button.warn { background: #f59e0b; }
    .result { margin-top: 1rem; padding: 1rem; background: #f3f4f6; border-radius: 6px; font-family: monospace; white-space: pre-wrap; }
    .success { background: #ecfdf5; color: #065f46; border: 1px solid #a7f3d0; }
    .error { background: #fef2f2; color: #991b1b; border: 1px solid #fecaca; }
    .grid { display: grid; grid-template-columns: 1fr 1fr; gap: 1.5rem; }
    @media (max-width: 768px) { .grid { grid-template-columns: 1fr; } }
  </style>
</head>
<body>

  <h1>Salt Keyserver</h1>
  <div class="warning">Salts auto-delete after 5 minutes!</div>

  <div class="grid">
    <!-- Upload -->
    <div class="card">
      <h2>Upload Salt</h2>
      <label>Email</label>
      <input id="upload-email" placeholder="you@example.com" value="test@example.com" />
      <label>Salt (text or base64)</label>
      <textarea id="upload-salt" rows="3" placeholder="Enter your salt here...">my-random-salt-123</textarea>
      <button onclick="upload()">Upload</button>
      <div id="upload-result" class="result"></div>
    </div>

    <!-- Search -->
    <div class="card">
      <h2>Search Salt</h2>
      <label>Email to Search</label>
      <input id="search-email" placeholder="test@example.com" value="test@example.com" />
      <button onclick="search()">Search</button>
      <button onclick="checkTTL()" class="warn">Check Time Left</button>
      <div id="search-result" class="result"></div>
    </div>
  </div>

  <script>
    const SERVER = "https://keyserver-backend.arsalanse.ir";

    async function upload() {
      const email = document.getElementById("upload-email").value.trim();
      const salt = document.getElementById("upload-salt").value.trim();
      if (!email || !salt) return show("upload-result", "Fill both fields!", "error");

      try {
        const res = await fetch(`${SERVER}/upload-salt`, {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({ email, salt })
        });
        if (res.ok) {
          show("upload-result", `Uploaded!\nSalt: ${salt}\nExpires in 5 min`, "success");
        } else throw new Error();
      } catch {
        show("upload-result", "Upload failed!", "error");
      }
    }

    async function search() {
      const email = document.getElementById("search-email").value.trim();
      if (!email) return show("search-result", "Enter email!", "error");

      try {
        const res = await fetch(`${SERVER}/salt/${encodeURIComponent(email)}`);
        if (!res.ok) throw new Error();
        const data = await res.json();
        show("search-result", `Found!\nSalt: ${data.salt}`, "success");
      } catch {
        show("search-result", `No salt (expired or not uploaded)`, "error");
      }
    }

    async function checkTTL() {
      const email = document.getElementById("search-email").value.trim();
      if (!email) return show("search-result", "Enter email!", "error");

      try {
        const res = await fetch(`${SERVER}/ttl/${encodeURIComponent(email)}`);
        if (!res.ok) throw new Error();
        const data = await res.json();
        show("search-result", `Time left: ${data.seconds_left} sec (~${Math.floor(data.seconds_left/60)} min)`, "success");
      } catch {
        show("search-result", `No salt found`, "error");
      }
    }

    function show(id, text, type) {
      const el = document.getElementById(id);
      el.textContent = text;
      el.className = `result ${type}`;
    }
  </script>

</body>
</html>
