<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Salt Key Server</title>
  <style>
    body { font-family: system-ui, sans-serif; max-width: 600px; margin: 2rem auto; padding: 1rem; }
    h1 { font-size: 1.5rem; }
    textarea, input { width: 100%; padding: 0.5rem; margin: 0.5rem 0; font: inherit; }
    button { padding: 0.75rem 1rem; font: inherit; background: #007bff; color: white; border: none; cursor: pointer; }
    button:hover { background: #0056b3; }
    pre { background: #f4f4f4; padding: 1rem; border-radius: 4px; overflow-x: auto; }
    .tab { margin: 1rem 0; }
    .tab button { background: #eee; color: black; margin-right: 0.5rem; }
    .tab button.active { background: #007bff; color: white; }
    .tabcontent { display: none; padding: 1rem 0; }
    .tabcontent.active { display: block; }
    a { color: #007bff; word-break: break-all; }
  </style>
</head>
<body>

  <h1>Salt Key Server</h1>

  <!-- Tabs -->
  <div class="tab">
    <button class="active" onclick="openTab(event, 'email')">Email Mode</button>
    <button onclick="openTab(event, 'anon')">Anonymous Link</button>
  </div>

  <!-- Email Mode -->
  <div id="email" class="tabcontent active">
    <h2>1. Upload Salt (with Email)</h2>
    <input type="email" id="email-input" placeholder="your@email.com" />
    <textarea id="salt-email" placeholder="Base64 salt (e.g. a2V5c2FsdA==)" rows="3"></textarea>
    <button onclick="uploadWithEmail()">Upload & Store</button>
    <pre id="result-email"></pre>

    <h2>2. Retrieve Later</h2>
    <input type="email" id="fetch-email" placeholder="your@email.com" />
    <button onclick="fetchByEmail()">Get Salt</button>
    <pre id="fetch-result"></pre>
  </div>

  <!-- Anonymous Mode -->
  <div id="anon" class="tabcontent">
    <h2>1. Upload Salt â†’ Get Link</h2>
    <textarea id="salt-anon" placeholder="Base64 salt (e.g. a2V5c2FsdA==)" rows="3"></textarea>
    <button onclick="uploadAnon()">Upload & Get Link</button>
    <pre id="result-anon"></pre>

    <h2>2. Open Link to Retrieve</h2>
    <p>Paste the link you received:</p>
    <input type="text" id="anon-url" placeholder="https://yoursite.com/s/abc123..." style="font-size:0.9rem;" />
    <button onclick="fetchByLink()">Fetch Salt from Link</button>
    <pre id="link-result"></pre>
  </div>

  <script>
    // const API_BASE = location.href.replace(/\/[^/]*$/, '');
    const API_BASE = "https://keyserver-backend.arsalanse.ir";

    function openTab(evt, tabName) {
      document.querySelectorAll(".tabcontent").forEach(t => t.classList.remove("active"));
      document.querySelectorAll(".tab button").forEach(b => b.classList.remove("active"));
      document.getElementById(tabName).classList.add("active");
      evt.currentTarget.classList.add("active");
    }

    // === EMAIL MODE ===
    async function uploadWithEmail() {
      const email = document.getElementById("email-input").value.trim();
      const salt = document.getElementById("salt-email").value.trim();
      const out = document.getElementById("result-email");
      if (!email || !salt) return alert("Fill both fields");

      try {
        const res = await fetch(`${API_BASE}/upload-salt`, {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({ email, salt })
        });
        const data = await res.json();
        out.textContent = JSON.stringify(data, null, 2);
      } catch (e) {
        out.textContent = "Error: " + e.message;
      }
    }

    async function fetchByEmail() {
      const email = document.getElementById("fetch-email").value.trim();
      const out = document.getElementById("fetch-result");
      if (!email) return alert("Enter email");

      try {
        const res = await fetch(`${API_BASE}/salt/${encodeURIComponent(email)}`);
        const data = await res.json();
        out.textContent = res.ok ? JSON.stringify(data, null, 2) : `Error ${res.status}: ${data.detail}`;
      } catch (e) {
        out.textContent = "Error: " + e.message;
      }
    }

    // === ANON MODE ===
    async function uploadAnon() {
      const salt = document.getElementById("salt-anon").value.trim();
      const out = document.getElementById("result-anon");
      if (!salt) return alert("Enter salt");

      try {
        const res = await fetch(`${API_BASE}/upload-salt-anon`, {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({ salt })
        });
        const data = await res.json();
        const pretty = JSON.stringify(data, null, 2);
        out.innerHTML = pretty.replace(/"(https?:\/\/[^"]+)"/g, '"<a href="$1" target="_blank">$1</a>"');
      } catch (e) {
        out.textContent = "Error: " + e.message;
      }
    }

    async function fetchByLink() {
      let url = document.getElementById("anon-url").value.trim();
      const out = document.getElementById("link-result");
      if (!url) return alert("Paste the link");

      if (!url.startsWith("http")) url = API_BASE + url.replace(/^\/+/, '/');

      try {
        const res = await fetch(url);
        const data = await res.json();
        out.textContent = res.ok ? JSON.stringify(data, null, 2) : `Error ${res.status}: ${data.detail || data}`;
      } catch (e) {
        out.textContent = "Error: " + e.message;
      }
    }
  </script>

</body>
</html>
